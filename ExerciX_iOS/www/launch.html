<!DOCTYPE HTML>
<html>
<head>
<title>ExerciX</title>
    <meta charset="utf-8">
<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script type="text/javascript" charset="utf-8" src="litegap.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/handlebars.js"></script>
    <link rel="stylesheet" href="css/index.css" type="text/css">
        <link rel="stylesheet" href="css/font-awesome.css" type="text/css">
            
            <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
            
            
            
            
<script type="text/javascript" charset="utf-8">


    document.addEventListener("deviceready", onDeviceReady, false);

    // PhoneGap is loaded and it is now safe to make calls PhoneGap methods
    function onDeviceReady() {
        // Now safe to use the PhoneGap API
        console.log("onDeviceReady() called");
     //   alert("onDeviceReady() called");

if (window.litegap) {
    window.litegap.getURL(function(err, url) {
        if (err) {
            console.log("error launching: " + err)
            alert("Aie ! Problème avec la DB ! Envoyez un mail à contact@exercix.net");
        } else {
            console.log("Couchbase Lite running at " + url);
         //   alert("Couchbase Lite running at " + url);
         //   alert('0');
            function delDB(){
                $.ajax({
                    type:"DELETE",
                    url:url+"/exercix", 
                    contentType: "application/json",
                    success:function(){
                        console.log("+1");
                        createDB();
                    },
                    error:function(data){
                        if(data.status == 404){
                            console.log("404, +1");
                            createDB();
                        }
                        else{
                        console.log('-1');
                        console.log(JSON.stringify(data));
                        window.location = 'launch.html';
                        }
                    }
                });
            }
            function createDB(){
                $.ajax({
                    type:"PUT",
                    url:url+"/exercix", 
                    contentType: "application/json",
                    success:function(){
                        console.log("+2");
                        saveDesign();
                    },
                    error:function(data){
                        console.log('-2');
                        console.log(JSON.stringify(data));
                        window.location = 'launch.html';
                    }
                });
            }

            function saveDesign(){
                $.ajax({
                    type:"PUT",
                    url:url+"/exercix/_design/design-doc", 
                    contentType: "application/json",
                    dataType: "json",
                    data : '{"views" : {"list-view" : {"map" : "function(doc){ if(doc.chapter){emit(doc.chapter, doc)}}"}}}',
                    success:function(){
                        console.log("+3");
                        getJSONFile();
                    },
                    error:function(data){
                        if(data.status==409){
                            getJSONFile()
                        }
                        else{
                            if(data.status==400){
                                console.log('-3');
                                console.log(JSON.stringify(data));
                                saveDesign();
                            }
                            else{
                            console.log('-3');
                            console.log(JSON.stringify(data));
                            window.location = 'launch.html';
                            }
                        }
                    }
                });
            }

            function getJSONFile(){
            $.ajax({
                dataType: "json",
                url: "data.json",
                success : function(data){
                console.log("+4")
                saveDocs(data);
                },
                error : function(data) {
                    console.log('-4');
                    console.log(JSON.stringify(data));
                    window.location = 'launch.html';
                }
            });
            }

            function saveDocs(data){
                    $.ajax({
                    type:"POST",
                    url:url+"/exercix/_bulk_docs", 
                    contentType: "application/json",
                    dataType: "json",
                    data : '{"docs" : ' + JSON.stringify(data) + '}',
                    success:function(){
                        console.log("+5");
                        $('#loading-screen').remove();
                        localStorage["db-loaded"] = true;
                        var userid    = Math.floor((1+Math.random())*0x1000000000).toString(16).substring(1);
                
                window.localStorage.setItem('userid', userid);
                window.localStorage.setItem('viewcount', '[]');
                window.localStorage.setItem('flags', '[]');
                window.localStorage.setItem('requests', '[]');
                         
                        window.location = 'index.html';;
                    },
                    error:function(data){
                        if(data.status==400){
                            console.log('-5');
                            console.log(JSON.stringify(data));
                            getJSONFile();
                        }
                        else{
                            console.log('-5');
                            console.log(JSON.stringify(data));
                            window.location = 'launch.html';
                        }
                    }
                });
            }

            delDB()
             
        }
    });
        } else {
            console.log("LiteGap plugin not installed.");
            alert("LiteGap plugin not installed.");
        }
    }

</script>


</head>
    <body id="launch-page">


        <div id="loading-screen"><div id="inner" style="font-size : 20px"><i class="icon-spin icon-spinner"></i> <br>Chargement de la base de données (juste la première fois)</div></div>


    </body>

</html>